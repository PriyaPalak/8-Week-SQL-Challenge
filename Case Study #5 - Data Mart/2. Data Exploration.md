# üè™ Case Study #5: Data Mart

## üìù Solution 2. Data Exploration

*Now that we're done with cleaning, let's explore the data and answer some business questions.*

### 1. What day of the week is used for each week_date value?

````sql
SELECT
  week_date,DATENAME(weekday,week_date) AS day_of_week
FROM clean_weekly_sales;
````
**Answer:**

### 2. What range of week numbers are missing from the dataset?

````sql
SELECT DISTINCT 
  week_number,calendar_year
FROM clean_weekly_sales
ORDER BY week_number,calendar_year;
````
**Answer:**

### 3. How many total transactions were there for each year in the dataset?

````sql
SELECT 
  calendar_year,FORMAT(SUM(transactions),'0,,M') AS total_transactions
FROM clean_weekly_sales
GROUP BY calendar_year
ORDER BY total_transactions;
````
**Answer:**

### 4. What is the total sales for each region for each month?

````sql
SELECT 
  region,month_number,calendar_year,FORMAT(SUM(sales),'$0,,,.00B') total_sales
FROM clean_weekly_sales
GROUP BY region,month_number,calendar_year
ORDER BY total_sales DESC;
````
**Answer:** 

### 5. What is the total count of transactions for each platform?

````sql
SELECT 
  platform,FORMAT(SUM(transactions),'0,,M') count_transactions
FROM clean_weekly_sales
GROUP BY platform
ORDER BY SUM(transactions);
````
**Answer:**

### 6. What is the percentage of sales for Retail vs Shopify for each month?

````sql
WITH monthly_sales_cte AS
(
SELECT 
  calendar_year,month_number,platform, SUM(sales) monthly_sales
FROM clean_weekly_sales
GROUP BY calendar_year,month_number,platform

)
SELECT 
  calendar_year,month_number,
  ROUND(MAX(CASE WHEN  platform = 'Retail' THEN monthly_sales ELSE NULL END)*100/SUM(monthly_sales),2) retail_percent,
  ROUND(MAX(CASE WHEN  platform = 'Shopify' THEN monthly_sales ELSE NULL END)*100/SUM(monthly_sales),2) shopify_percent
FROM monthly_sales_cte
GROUP BY calendar_year,month_number;
````
**Answer:**

### 7. What is the percentage of sales by demographic for each year in the dataset?

````sql
WITH yearly_sales_cte AS
(
SELECT 
  calendar_year,demographic,SUM(sales) yearly_sales
FROM clean_weekly_sales
GROUP BY calendar_year,demographic
)
SELECT 
  calendar_year,
  ROUND(MAX(CASE WHEN demographic = 'Families' THEN yearly_sales ELSE NULL END)*100/SUM(yearly_sales),2) families_percent,
  ROUND(MAX(CASE WHEN demographic = 'Couples' THEN yearly_sales ELSE NULL END)*100/SUM(yearly_sales),2) couples_percent,
  ROUND(MAX(CASE WHEN demographic = 'unknown' THEN yearly_sales ELSE NULL END)*100/SUM(yearly_sales),2) unknown_percent
FROM yearly_sales_cte
GROUP BY calendar_year;
````

**Answer:**

### 8. Which age_band and demographic values contribute the most to Retail sales?

````sql
SELECT 
  age_band,demographic,SUM(sales) AS retail_sales, ROUND(100*SUM(sales)/SUM(SUM(sales)) OVER(),2) AS contribution_percent
	-- Cannot apply aggregate function to an aggregate value, need to use the OVER() clause with SUM(SUM(sales))
FROM clean_weekly_sales                                  
WHERE platform = 'Retail'
GROUP BY age_band,demographic
ORDER BY retail_sales DESC;
````
**Answer:** 

### 9. Can we use the avg_transaction column to find the average transaction size for each year for Retail vs Shopify? If not - how would you calculate it instead?

````sql
SELECT 
  calendar_year,platform,
  ROUND(AVG(avg_transaction),0) AS avg_avg_transaction_size,
  ROUND(SUM(sales)/SUM(transactions),0) AS avg_transaction_size
FROM clean_weekly_sales
GROUP BY calendar_year,platform
ORDER BY calendar_year,platform; 
````
**Answer:**
